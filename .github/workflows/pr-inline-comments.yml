name: PR Inline Code Comments

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
        description: 'Pull Request number to post comments on'
      repo_owner:
        required: true
        type: string
        description: 'Repository owner'
      repo_name:
        required: true
        type: string
        description: 'Repository name'

permissions:
  pull-requests: write
  contents: read
  issues: read
  checks: write

jobs:
  inline-review:
    runs-on: ubuntu-latest
    name: Post Inline Review Comments

    steps:
      - name: Checkout CI-Standards repo
        uses: actions/checkout@v4
        with:
          repository: JakoLantern/CI-Standards
          fetch-depth: 0

      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          path: caller-repo
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Generate PR comments from code violations
        id: violations
        env:
          BASE_REF: origin/${{ github.base_ref }}
        run: |
          cd caller-repo
          node ../scripts/generate-pr-comments.js > violations.json 2>&1 || true
          cat violations.json
          
          # Check if violations found and fail if there are any
          VIOLATION_COUNT=$(grep -o '"path"' violations.json | wc -l)
          echo "violation_count=$VIOLATION_COUNT" >> $GITHUB_OUTPUT
          
          if [ $VIOLATION_COUNT -gt 0 ]; then
            echo "Found $VIOLATION_COUNT violations"
            exit 1
          fi

      - name: Post violations as Checks annotations
        if: always()
        uses: actions/github-script@v7
        env:
          REPO_OWNER: ${{ inputs.repo_owner }}
          REPO_NAME: ${{ inputs.repo_name }}
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const repoOwner = process.env.REPO_OWNER;
            const repoName = process.env.REPO_NAME;
            const prNumber = parseInt(process.env.PR_NUMBER);

            let comments = [];

            try {
              const output = fs.readFileSync('caller-repo/violations.json', 'utf8');
              const jsonMatch = output.match(/\[[\s\S]*\]/);
              if (jsonMatch) {
                comments = JSON.parse(jsonMatch[0]);
              }
            } catch (error) {
              console.log('Could not parse violations:', error.message);
            }

            if (comments.length > 0) {
              // Convert violations to Checks API annotations
              const annotations = comments.map(c => ({
                path: c.path,
                start_line: parseInt(c.line),
                end_line: parseInt(c.line),
                annotation_level: 'warning',
                title: 'Code Standard Violation',
                message: c.body
              }));

              console.log(`Creating check run with ${annotations.length} annotations...`);

              // GitHub Checks API batches max 50 annotations per request
              // Create one check run with batched annotations
              const batchSize = 50;
              for (let i = 0; i < annotations.length; i += batchSize) {
                const batch = annotations.slice(i, i + batchSize);
                const batchNum = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(annotations.length / batchSize);

                const checkResult = await github.rest.checks.create({
                  owner: repoOwner,
                  repo: repoName,
                  name: `Code Review (Batch ${batchNum}/${totalBatches})`,
                  head_sha: context.payload.pull_request.head.sha,
                  status: 'completed',
                  conclusion: 'action_required',
                  output: {
                    title: `Code Standard Violations - Batch ${batchNum}`,
                    summary: `Found ${batch.length} violations in this batch`,
                    annotations: batch
                  }
                });

                console.log(`✓ Posted check run batch ${batchNum} with ${batch.length} annotations`);
              }

              console.log(`✓ Posted all violations as ${Math.ceil(annotations.length / batchSize)} check run(s)!`);
            } else {
              console.log('✓ No violations found!');
            }
