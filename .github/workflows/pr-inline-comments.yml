name: PR Inline Code Comments

on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  inline-review:
    runs-on: ubuntu-latest
    name: Post Inline Review Comments

    steps:
      - name: Checkout caller repo first
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout reusable workflow repo
        uses: actions/checkout@v4
        with:
          repository: JakoLantern/CI-Standards
          fetch-depth: 0
          path: .ci-standards

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --prefix .ci-standards

      - name: Generate PR comments from code violations
        id: violations
        env:
          BASE_REF: origin/${{ github.base_ref }}
        run: |
          node .ci-standards/scripts/generate-pr-comments.js > violations.json 2>&1 || true
          cat violations.json

      - name: Post violations as PR Review Comments
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Load violations from current repo root
            let rawData = fs.readFileSync('violations.json', 'utf8');
            const jsonStart = rawData.indexOf('[');
            const jsonEnd = rawData.lastIndexOf(']') + 1;
            const comments = JSON.parse(rawData.substring(jsonStart, jsonEnd));

            console.log(`Found ${comments.length} violations`);

            if (comments.length > 0) {
              // Get PR details
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              console.log(`Creating review for PR #${context.issue.number}, commit: ${pr.data.head.sha}`);

              // Format comments for PR review (max 30 per review)
              const reviewComments = comments.slice(0, 30).map(c => ({
                path: c.path,
                line: parseInt(c.line),
                body: c.body
              }));

              try {
                // Create a review with REQUEST_CHANGES to require resolution
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: pr.data.head.sha,
                  body: `## ðŸ” Code Standards Review\n\nFound **${comments.length}** violation(s) that need to be resolved.\n\n${comments.length > 30 ? 'âš ï¸ Showing first 30 violations. Check logs for complete list.' : ''}`,
                  event: 'REQUEST_CHANGES',
                  comments: reviewComments
                });

                console.log(`âœ“ Posted ${reviewComments.length} review comments requiring resolution!`);
                
                // If more than 30 comments, post remaining as individual comments
                if (comments.length > 30) {
                  console.log(`Posting ${comments.length - 30} additional comments...`);
                  for (let i = 30; i < Math.min(comments.length, 60); i++) {
                    const c = comments[i];
                    try {
                      await github.rest.pulls.createReviewComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.issue.number,
                        commit_id: pr.data.head.sha,
                        path: c.path,
                        line: parseInt(c.line),
                        body: c.body
                      });
                    } catch (err) {
                      console.log(`Could not post comment on ${c.path}:${c.line} - ${err.message}`);
                    }
                  }
                }
              } catch (error) {
                console.log(`Error creating review: ${error.message}`);
                // Fallback: post as issue comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `## ðŸ” Code Standards Violations\n\nFound **${comments.length}** violations:\n\n${comments.slice(0, 10).map(c => `- \`${c.path}:${c.line}\` - ${c.body}`).join('\n')}\n\n${comments.length > 10 ? `...and ${comments.length - 10} more. Check workflow logs for details.` : ''}`
                });
              }
            } else {
              console.log('âœ“ No violations found!');
            }
