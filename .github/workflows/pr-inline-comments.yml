name: PR Inline Code Comments

on:
  workflow_call:

permissions:
  pull-requests: write
  contents: read
  checks: write

jobs:
  inline-review:
    runs-on: ubuntu-latest
    name: Post Inline Review Comments

    steps:
      - name: Checkout reusable workflow repo
        uses: actions/checkout@v4
        with:
          repository: JakoLantern/CI-Standards
          fetch-depth: 0
          path: .ci-standards

      - name: Checkout caller repo (default to repo root)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --prefix .ci-standards

      - name: Generate PR comments from code violations
        id: violations
        env:
          BASE_REF: origin/${{ github.base_ref }}
        run: |
          node .ci-standards/scripts/generate-pr-comments.js > violations.json 2>&1 || true
          cat violations.json

      - name: Post violations as Checks annotations
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Load violations from current repo root
            let rawData = fs.readFileSync('violations.json', 'utf8');
            const jsonStart = rawData.indexOf('[');
            const jsonEnd = rawData.lastIndexOf(']') + 1;
            const comments = JSON.parse(rawData.substring(jsonStart, jsonEnd));

            console.log(`Found ${comments.length} violations`);

            if (comments.length > 0) {
              // Paths are naturally correct - script runs in repo root
              const annotations = comments.map(c => ({
                path: c.path,
                start_line: parseInt(c.line),
                end_line: parseInt(c.line),
                annotation_level: 'warning',
                title: 'Code Standard Violation',
                message: c.body
              }));

              // Use automatic context - no manual passing needed
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              console.log(`Using commit SHA: ${pr.data.head.sha}`);

              // Post annotations in batches of 50
              const batchSize = 50;
              for (let i = 0; i < annotations.length; i += batchSize) {
                const batch = annotations.slice(i, i + batchSize);
                const batchNum = Math.floor(i / batchSize) + 1;
                const totalBatches = Math.ceil(annotations.length / batchSize);

                await github.rest.checks.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: `Code Review Standards`,
                  head_sha: pr.data.head.sha,
                  status: 'completed',
                  conclusion: 'failure',
                  output: {
                    title: `Standards Check Failures`,
                    summary: `Found ${comments.length} violations. Please resolve these inline.`,
                    annotations: batch
                  }
                });

                console.log(`✓ Posted batch ${batchNum}/${totalBatches} with ${batch.length} annotations`);
              }

              console.log(`✓ All violations posted!`);
            } else {
              console.log('✓ No violations found!');
            }
